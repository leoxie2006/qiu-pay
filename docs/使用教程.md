# 使用教程

## 一、前期准备工作

### 1.1 注册支付宝开放平台

1. 访问 [支付宝开放平台](https://open.alipay.com/) 完成注册及实名认证
2. 登录后进入控制台，选择 **网页/移动应用** → **创建网页/移动应用**
3. 填写应用信息并提交审核（审核时间通常为 1 天内）

![注册开放平台](/docs/public/1.png)
![创建应用](/docs/public/2.png)

### 1.2 配置网页应用 - 接口加签方式

1. 审核通过后，进入应用详情页，点击 **产品绑定**

![产品绑定](/docs/public/3.png)

2. 在 **开发设置** 中，选择 **接口加签方式** → **密钥/证书**

![开发设置](/docs/public/4.png)

3. 选择 **密钥**（普遍适用），按以下步骤操作：

![选择密钥模式](/docs/public/5.png)

- 下载支付宝提供的 [密钥生成工具](https://opendocs.alipay.com/common/02kipk)

![下载工具](/docs/public/6.png)
![安装工具](/docs/public/7.png)

- 打开工具，选择密钥类型（如 RSA2），点击 **生成密钥**

![生成密钥](/docs/public/8.png)

- 保存生成的 **公钥** 和 **私钥**（私钥需严格保密）

![保存密钥](/docs/public/9.png)

4. 返回开放平台，上传公钥并确认，提示 **密钥保存成功** 即完成

![上传公钥](/docs/public/10.png)

5. 如果提示其他操作，点击 **稍后操作** 即可

![稍后操作](/docs/public/11.png)

---

## 二、配置 Qiu-Pay

### 2.1 登录管理后台

使用 `.env` 中配置的管理员账号密码登录系统。

### 2.2 创建商户

1. 进入 **商户管理** 页面，点击 **新增商户**

![商户管理](/docs/public/12.png)

2. 填写用户名和邮箱（邮箱暂时没有实际用途），系统会自动生成商户 ID（pid）和密钥（key）

![创建商户](/docs/public/13.png)

### 2.3 配置支付宝凭证

1. 在商户列表中点击 **凭证配置**

![凭证配置](/docs/public/14.png)

2. 填写以下信息：
   - **应用 ID**：支付宝开放平台的 APPID
   - **应用公钥**：前面在开放平台上传的公钥
   - **应用私钥**：密钥生成工具保存的私钥

![填写凭证](/docs/public/15.png)
![确认凭证](/docs/public/16.png)
![私钥参考](/docs/public/9.png)

### 2.4 上传收款二维码

为避免支付宝风控，需要使用商家收款码：

1. 手机支付宝中搜索 **商家服务**

![搜索商家服务](/docs/public/17.png)
![进入商家服务](/docs/public/18.png)
![商家服务页面](/docs/public/19.png)

2. 打开 **收钱二维码**，保存图片后上传到 Qiu-Pay

![保存收款码](/docs/public/20.png)

3. 上传后系统会自动验证收款码有效性

![验证中](/docs/public/21.png)
![验证成功](/docs/public/22.png)

---

## 三、管理后台功能说明

### 3.1 仪表盘

展示今日/昨日/总计的订单数、成功数和金额统计，以及近期订单趋势图表。

### 3.2 商户管理

- 创建/编辑商户
- 启用/禁用商户
- 管理商户支付宝凭证（支持多凭证）
- 查看商户余额和订单统计

### 3.3 订单管理

- 按状态、商户、时间筛选订单
- 查看订单详情和回调日志
- 手动重新通知（重发回调）
- 取消未支付订单
- 导出订单数据

### 3.4 系统设置

- 修改管理员密码
- 配置系统级支付宝凭证（作为商户凭证的兜底）
- 上传系统收款二维码

---

## 四、常见问题

### Q: 支付后订单状态没有更新？

系统通过轮询支付宝余额变化来检测支付，有未完成订单时每秒检测一次。如果长时间未更新，请检查：
- 支付宝凭证是否正确配置
- 收款二维码是否有效
- 服务器网络是否能访问支付宝 API

### Q: 回调通知没有收到？

- 确认 `notify_url` 是否可从服务器外网访问
- 在订单详情页查看回调日志，确认 HTTP 状态码和响应内容
- 系统会自动重试最多 5 次

### Q: 金额为什么和下单时不一样？

为了区分同时段的多笔同金额订单，系统会自动在原始金额基础上微调尾数（最多 +0.99 元）。实际扣款金额以返回的 `money` 字段为准。

### Q: 订单多久会过期？

未支付的订单在 10 分钟后自动过期，状态变为"已超时"。
